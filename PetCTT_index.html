<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="theme-color" content="#0b1220" />
  <title>PetCTT - ë™ë¬¼ëŒ€í™” + ê±´ê°•ì²´í¬ v2.0</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    :root {
      --bg: #0b1220;
      --card: #0f1b33;
      --text: #e8f0ff;
      --muted: #9fb3d9;
      --primary: #37d67a;
      --danger: #ff5a5f;
      --warn: #ffbd2e;
      --line: rgba(255,255,255,.10);
      --shadow: 0 14px 40px rgba(0,0,0,.35);
      --radius: 18px;
      --mono: 'Courier New', monospace;
      --sans: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }

    html, body { width: 100%; height: 100%; }
    
    body {
      background: radial-gradient(1200px 700px at 20% -10%, rgba(55,214,122,.18), transparent 55%),
                  radial-gradient(900px 600px at 110% 10%, rgba(74,144,226,.18), transparent 50%),
                  radial-gradient(900px 700px at 30% 120%, rgba(255,189,46,.10), transparent 55%),
                  var(--bg);
      color: var(--text);
      font-family: var(--sans);
      overflow-x: hidden;
    }

    .container {
      max-width: 520px;
      margin: 0 auto;
      padding: 20px 16px 40px;
      min-height: 100vh;
    }

    /* Header */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding: 12px 0;
      border-bottom: 1px solid var(--line);
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 18px;
      font-weight: 900;
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 14px;
      background: rgba(0,0,0,.3);
      border: 1px solid var(--line);
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--muted);
      box-shadow: 0 0 0 3px rgba(159,179,217,.2);
    }

    .status-dot.active {
      background: var(--primary);
      box-shadow: 0 0 0 3px rgba(55,214,122,.3);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }

    /* Tabs */
    .tab-nav {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-bottom: 20px;
    }

    .tab-btn {
      padding: 12px;
      background: rgba(255,255,255,.05);
      border: 1px solid var(--line);
      border-radius: 12px;
      color: var(--muted);
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
    }

    .tab-btn:hover {
      background: rgba(255,255,255,.08);
      border-color: rgba(55,214,122,.3);
    }

    .tab-btn.active {
      background: rgba(55,214,122,.16);
      border-color: rgba(55,214,122,.4);
      color: var(--text);
    }

    /* Card */
    .card {
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
      margin-bottom: 16px;
    }

    .card-header {
      padding: 16px;
      background: rgba(0,0,0,.15);
      border-bottom: 1px solid var(--line);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .card-title {
      font-size: 15px;
      font-weight: 800;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .card-body {
      padding: 16px;
    }

    /* Buttons */
    .btn {
      padding: 12px 16px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.04);
      color: var(--text);
      border-radius: 12px;
      font-weight: 700;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      width: 100%;
      min-height: 44px;
    }

    .btn:hover {
      background: rgba(255,255,255,.08);
    }

    .btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .btn.primary {
      background: rgba(55,214,122,.18);
      border-color: rgba(55,214,122,.4);
    }

    .btn.primary:hover:not(:disabled) {
      background: rgba(55,214,122,.25);
    }

    .btn.danger {
      background: rgba(255,90,95,.14);
      border-color: rgba(255,90,95,.4);
    }

    .btn.danger:hover:not(:disabled) {
      background: rgba(255,90,95,.22);
    }

    .btn.ghost {
      background: transparent;
      border: 1px solid var(--line);
      width: auto;
      padding: 10px 14px;
    }

    .btn-group {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin: 16px 0;
    }

    .btn-group.full {
      grid-template-columns: 1fr;
    }

    /* Selection */
    .selector {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      padding: 8px;
      background: rgba(0,0,0,.15);
      border-radius: 12px;
      border: 1px solid var(--line);
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    .chip {
      padding: 8px 14px;
      background: rgba(255,255,255,.04);
      border: 1px solid var(--line);
      border-radius: 20px;
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.2s;
    }

    .chip:hover {
      background: rgba(255,255,255,.08);
    }

    .chip.active {
      background: rgba(55,214,122,.16);
      border-color: rgba(55,214,122,.4);
      color: var(--primary);
    }

    /* Meter */
    .meter {
      height: 14px;
      background: rgba(255,255,255,.08);
      border: 1px solid var(--line);
      border-radius: 20px;
      overflow: hidden;
      margin-bottom: 12px;
    }

    .meter-fill {
      height: 100%;
      background: linear-gradient(90deg, rgba(55,214,122,.8), rgba(255,189,46,.8));
      width: 0%;
      transition: width 0.1s ease-out;
    }

    /* Stats Grid */
    .stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin: 16px 0;
    }

    .stat-box {
      padding: 12px;
      background: rgba(0,0,0,.15);
      border: 1px solid var(--line);
      border-radius: 12px;
    }

    .stat-label {
      font-size: 11px;
      color: var(--muted);
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stat-value {
      font-size: 16px;
      font-weight: 800;
      font-family: var(--mono);
      color: var(--text);
    }

    /* Log */
    .log {
      background: rgba(0,0,0,.2);
      border: 1px solid var(--line);
      border-radius: 12px;
      overflow: hidden;
      margin-top: 12px;
    }

    .log-header {
      padding: 10px 14px;
      background: rgba(0,0,0,.3);
      border-bottom: 1px solid var(--line);
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
      color: var(--muted);
      font-weight: 700;
    }

    .log-body {
      max-height: 280px;
      overflow-y: auto;
      padding: 10px;
    }

    .log-item {
      padding: 10px;
      margin-bottom: 8px;
      background: rgba(255,255,255,.03);
      border: 1px solid rgba(255,255,255,.06);
      border-radius: 8px;
      font-size: 13px;
      line-height: 1.4;
    }

    .log-item-time {
      font-size: 11px;
      color: var(--muted);
      margin-bottom: 4px;
      font-family: var(--mono);
    }

    .log-item-text {
      color: var(--text);
      word-break: break-word;
    }

    /* Hidden sections */
    .section {
      display: none;
    }

    .section.active {
      display: block;
    }

    /* Info Box */
    .info-box {
      padding: 12px;
      margin: 12px 0;
      background: rgba(255,189,46,.1);
      border: 1px solid rgba(255,189,46,.3);
      border-radius: 8px;
      font-size: 12px;
      line-height: 1.5;
      color: var(--muted);
    }

    .info-box.success {
      background: rgba(55,214,122,.1);
      border-color: rgba(55,214,122,.3);
    }

    .info-box.error {
      background: rgba(255,90,95,.1);
      border-color: rgba(255,90,95,.3);
    }

    /* Modal */
    .modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 16px;
    }

    .modal-backdrop.show {
      display: flex;
    }

    .modal {
      background: rgba(15,27,51,.98);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      max-width: 420px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0,0,0,.6);
    }

    .modal-header {
      padding: 16px;
      border-bottom: 1px solid var(--line);
      font-weight: 800;
      font-size: 15px;
    }

    .modal-body {
      padding: 16px;
      color: var(--muted);
      font-size: 14px;
      line-height: 1.5;
    }

    .modal-footer {
      padding: 16px;
      border-top: 1px solid var(--line);
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    /* Footer */
    .footer {
      text-align: center;
      margin-top: 24px;
      padding-top: 16px;
      border-top: 1px solid var(--line);
      font-size: 12px;
      color: var(--muted);
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: rgba(255,255,255,.1);
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: rgba(255,255,255,.2);
    }

    /* Animations */
    .fade-in {
      animation: fadeIn 0.3s ease-in;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    /* Utility */
    .text-center { text-align: center; }
    .mb-8 { margin-bottom: 8px; }
    .mb-12 { margin-bottom: 12px; }
    .mb-16 { margin-bottom: 16px; }
    .mt-8 { margin-top: 8px; }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <div class="logo">
        <span>ğŸ¾</span> PetCTT
      </div>
      <div class="status-badge">
        <span class="status-dot" id="statusDot"></span>
        <span id="statusText">ì¤€ë¹„ë¨</span>
      </div>
    </div>

    <!-- Tab Navigation -->
    <div class="tab-nav">
      <button class="tab-btn active" data-tab="live">ğŸ¶ ë™ë¬¼ëŒ€í™”</button>
      <button class="tab-btn" data-tab="health">â¤ï¸ ê±´ê°•ì²´í¬</button>
      <button class="tab-btn" data-tab="records">ğŸ“’ ê¸°ë¡</button>
    </div>

    <!-- Section: LIVE TALK -->
    <section id="live" class="section active">
      <div class="card">
        <div class="card-header">
          <div class="card-title">ğŸ™ï¸ LIVE ë™ë¬¼ëŒ€í™”</div>
          <span style="font-size:12px; color:var(--muted);" id="animalSelected">ê°•ì•„ì§€</span>
        </div>
        <div class="card-body">
          <!-- Animal Selector -->
          <div class="selector" id="animalSelector">
            <div class="chip active" data-animal="dog">ğŸ¶ ê°•ì•„ì§€</div>
            <div class="chip" data-animal="cat">ğŸ± ê³ ì–‘ì´</div>
            <div class="chip" data-animal="bird">ğŸ¤ ë³‘ì•„ë¦¬</div>
            <div class="chip" data-animal="rabbit">ğŸ° í† ë¼</div>
          </div>

          <!-- Controls -->
          <div class="btn-group">
            <button class="btn primary" id="btnLiveStart">ğŸ™ï¸ ì‹œì‘</button>
            <button class="btn danger" id="btnLiveStop" disabled>â¹ï¸ ì¤‘ì§€</button>
          </div>

          <!-- Audio Level -->
          <div class="mb-12">
            <div style="font-size:12px; font-weight:700; margin-bottom:6px; color:var(--muted);">ğŸšï¸ ìŒì„± ë ˆë²¨</div>
            <div class="meter">
              <div class="meter-fill" id="liveMeterFill"></div>
            </div>
          </div>

          <!-- Stats -->
          <div class="stats">
            <div class="stat-box">
              <div class="stat-label">ìƒíƒœ</div>
              <div class="stat-value" id="liveState">IDLE</div>
            </div>
            <div class="stat-box">
              <div class="stat-label">ë¬´ìŒ(%)</div>
              <div class="stat-value" id="liveSilence">0%</div>
            </div>
            <div class="stat-box">
              <div class="stat-label">ìŒì„± ì‹œê°„</div>
              <div class="stat-value" id="liveTime">0.0s</div>
            </div>
            <div class="stat-box">
              <div class="stat-label">ìµœëŒ€ ë ˆë²¨</div>
              <div class="stat-value" id="liveMax">0.000</div>
            </div>
          </div>

          <!-- Log -->
          <div class="log">
            <div class="log-header">
              <span>ëŒ€í™” ë¡œê·¸</span>
              <button class="btn ghost" id="btnClearLive" style="font-size:11px;">ğŸ§¹ ë¹„ìš°ê¸°</button>
            </div>
            <div class="log-body" id="liveLogBody"></div>
          </div>

          <div class="info-box">
            ğŸ’¡ <b>"ì‹œì‘" ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ë§ˆì´í¬ ê¶Œí•œì„ ìš”ì²­í•©ë‹ˆë‹¤.</b> í—ˆìš© ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”. (í•„ìˆ˜)
          </div>
        </div>
      </div>
    </section>

    <!-- Section: HEALTH CHECK -->
    <section id="health" class="section">
      <div class="card">
        <div class="card-header">
          <div class="card-title">â¤ï¸ ê±´ê°•ì²´í¬ (30ì´ˆ)</div>
          <span style="font-size:12px; color:var(--muted);">30ì´ˆ ì¸¡ì •</span>
        </div>
        <div class="card-body">
          <div style="font-size:13px; color:var(--muted); line-height:1.5; margin-bottom:12px;">
            ë§ˆì´í¬ë¡œ ìŒì„±/í˜¸í¡ ì‹ í˜¸ë¥¼ ì¸¡ì •í•©ë‹ˆë‹¤.
          </div>

          <!-- Audio Level -->
          <div class="mb-12">
            <div style="font-size:12px; font-weight:700; margin-bottom:6px; color:var(--muted);">ğŸšï¸ ìŒì„± ë ˆë²¨</div>
            <div class="meter">
              <div class="meter-fill" id="healthMeterFill"></div>
            </div>
          </div>

          <!-- Stats -->
          <div class="stats">
            <div class="stat-box">
              <div class="stat-label">ìƒíƒœ</div>
              <div class="stat-value" id="healthState">ëŒ€ê¸°</div>
            </div>
            <div class="stat-box">
              <div class="stat-label">ë‚¨ì€ ì‹œê°„</div>
              <div class="stat-value" id="healthTime">30s</div>
            </div>
            <div class="stat-box">
              <div class="stat-label">í‰ê·  ë ˆë²¨</div>
              <div class="stat-value" id="healthAvg">0.000</div>
            </div>
            <div class="stat-box">
              <div class="stat-label">í”¼í¬ íšŸìˆ˜</div>
              <div class="stat-value" id="healthPeaks">0</div>
            </div>
            <div class="stat-box">
              <div class="stat-label">ë¬´ìŒ ë¹„ìœ¨</div>
              <div class="stat-value" id="healthSilence">0%</div>
            </div>
            <div class="stat-box">
              <div class="stat-label">ì‹ í˜¸ ê°•ë„</div>
              <div class="stat-value" id="healthStrength">ë‚®ìŒ</div>
            </div>
          </div>

          <!-- Controls -->
          <div class="btn-group">
            <button class="btn primary" id="btnHealthStart">ğŸ©º ì‹œì‘</button>
            <button class="btn danger" id="btnHealthStop" disabled>â¹ï¸ ì¤‘ì§€</button>
          </div>

          <!-- Result -->
          <div class="log">
            <div class="log-header">
              <span>ê²°ê³¼</span>
              <button class="btn ghost" id="btnSaveHealth" style="font-size:11px;" disabled>ğŸ’¾ ì €ì¥</button>
            </div>
            <div class="log-body" id="healthResultBody">
              <div style="color:var(--muted); font-size:13px;">ì¸¡ì • ì™„ë£Œ í›„ ê²°ê³¼ê°€ í‘œì‹œë©ë‹ˆë‹¤.</div>
            </div>
          </div>

          <div class="info-box">
            âš ï¸ ì¸¡ì • ì¤‘ì—ëŠ” ìµœëŒ€í•œ ì¡°ìš©í•œ í™˜ê²½ì„ ìœ ì§€í•´ì£¼ì„¸ìš”.
          </div>
        </div>
      </div>
    </section>

    <!-- Section: RECORDS -->
    <section id="records" class="section">
      <div class="card">
        <div class="card-header">
          <div class="card-title">ğŸ“’ ê¸°ë¡</div>
          <span style="font-size:12px; color:var(--muted);" id="recordCount">0ê°œ</span>
        </div>
        <div class="card-body">
          <!-- Export Buttons -->
          <div class="btn-group">
            <button class="btn" id="btnExportJSON">â¬‡ï¸ JSON</button>
            <button class="btn" id="btnExportCSV">â¬‡ï¸ CSV</button>
          </div>

          <!-- Records List -->
          <div class="log">
            <div class="log-header">
              <span>ì €ì¥ëœ ê¸°ë¡</span>
              <button class="btn danger" id="btnDeleteAll" style="font-size:11px;">ğŸ—‘ï¸ ì „ì²´ì‚­ì œ</button>
            </div>
            <div class="log-body" id="recordsList">
              <div style="color:var(--muted); font-size:13px;">ì•„ì§ ì €ì¥ëœ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>
            </div>
          </div>

          <div class="info-box">
            ğŸ“ ê¸°ë¡ì€ ë¸Œë¼ìš°ì € ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì— ì €ì¥ë©ë‹ˆë‹¤.
          </div>
        </div>
      </div>
    </section>

    <!-- Footer -->
    <div class="footer">
      <div>Â© 2026 PetCTT v2.0</div>
      <div style="margin-top:8px; font-size:11px; opacity:0.7;">
        ë‹¨ì¼ HTML ì• í”Œë¦¬ì¼€ì´ì…˜ Â· ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì‚¬ìš©
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal-backdrop" id="modalBackdrop">
    <div class="modal">
      <div class="modal-header" id="modalTitle">í™•ì¸</div>
      <div class="modal-body" id="modalBody">ë‚´ìš©</div>
      <div class="modal-footer">
        <button class="btn ghost" id="modalBtnCancel">ì·¨ì†Œ</button>
        <button class="btn primary" id="modalBtnOk">í™•ì¸</button>
      </div>
    </div>
  </div>

<script>
(() => {
  // ===== UTILITIES =====
  const $ = (sel) => document.querySelector(sel);
  const $$ = (sel) => Array.from(document.querySelectorAll(sel));
  
  const now = () => new Date();
  const fmtTime = (dt = now()) => dt.toLocaleTimeString('ko-KR', { hour12: false });
  const fmtDatetime = (dt = now()) => dt.toLocaleString('ko-KR');

  // Audio Beep
  async function beep(freq = 880, dur = 0.05) {
    try {
      const ac = new (window.AudioContext || window.webkitAudioContext)();
      const osc = ac.createOscillator();
      const gain = ac.createGain();
      osc.frequency.value = freq;
      osc.type = 'sine';
      gain.gain.setValueAtTime(0.15, ac.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.001, ac.currentTime + dur);
      osc.connect(gain);
      gain.connect(ac.destination);
      osc.start(ac.currentTime);
      osc.stop(ac.currentTime + dur);
    } catch (e) {}
  }

  // Modal
  function showModal(title, body, okText = 'í™•ì¸', cancelText = 'ì·¨ì†Œ') {
    return new Promise((resolve) => {
      $('#modalTitle').textContent = title;
      $('#modalBody').innerHTML = body;
      $('#modalBtnOk').textContent = okText;
      $('#modalBtnCancel').textContent = cancelText;
      $('#modalBackdrop').classList.add('show');

      const cleanup = () => {
        $('#modalBackdrop').classList.remove('show');
        $('#modalBtnOk').onclick = null;
        $('#modalBtnCancel').onclick = null;
      };

      $('#modalBtnOk').onclick = () => { cleanup(); resolve(true); };
      $('#modalBtnCancel').onclick = () => { cleanup(); resolve(false); };
    });
  }

  // ===== STATE =====
  const state = {
    animal: 'dog',
    isLiveActive: false,
    isHealthActive: false,
    mediaStream: null,
    audioContext: null,
    analyser: null,
    animationId: null,

    liveStats: {
      silenceCount: 0,
      totalCount: 0,
      voiceTime: 0,
      maxLevel: 0,
      startTime: 0
    },

    healthStats: {
      startTime: 0,
      duration: 30,
      samples: [],
      peakCount: 0,
      silenceCount: 0,
      currentResult: null
    }
  };

  // ===== LOG =====
  function addLiveLog(actor, message) {
    const item = document.createElement('div');
    item.className = 'log-item fade-in';
    item.innerHTML = `
      <div class="log-item-time">${fmtTime()} Â· ${actor}</div>
      <div class="log-item-text">${escapeHtml(message)}</div>
    `;
    const body = $('#liveLogBody');
    body.insertBefore(item, body.firstChild);
    
    // Keep max 50 items
    while (body.children.length > 50) {
      body.removeChild(body.lastChild);
    }
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // ===== AUDIO =====
  async function initAudio() {
    if (state.mediaStream) return;
    try {
      // ë§ˆì´í¬ ê¶Œí•œ ìš”ì²­ ì „ ì•Œë¦¼
      await showModal(
        'ğŸ¤ ë§ˆì´í¬ ê¶Œí•œ í•„ìš”',
        'ë‹¤ìŒ í™”ë©´ì—ì„œ <b>"í—ˆìš©" ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</b><br><br>' +
        'â€¢ Chrome/Edge: ì£¼ì†Œì°½ ì™¼ìª½ ìë¬¼ì‡  â†’ ë§ˆì´í¬ í—ˆìš©<br>' +
        'â€¢ Firefox: ë§ˆì´í¬ í—ˆìš© íŒì—…ì—ì„œ "í—ˆìš©" ì„ íƒ<br>' +
        'â€¢ Safari: ì„¤ì • â†’ ë§ˆì´í¬ í—ˆìš©<br><br>' +
        '<span style="font-size:11px; color:var(--muted);">ê¶Œí•œì„ ê±°ë¶€í•˜ë©´ ê¸°ëŠ¥ì´ ì‘ë™í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</span>',
        'í™•ì¸'
      );

      state.mediaStream = await navigator.mediaDevices.getUserMedia({ 
        audio: {
          echoCancellation: true,
          noiseSuppression: true,
          autoGainControl: false
        } 
      });
      
      const ac = state.audioContext || new (window.AudioContext || window.webkitAudioContext)();
      state.audioContext = ac;

      if (ac.state === 'suspended') {
        await ac.resume();
      }

      const source = ac.createMediaStreamSource(state.mediaStream);
      const analyser = ac.createAnalyser();
      analyser.fftSize = 2048;
      source.connect(analyser);
      state.analyser = analyser;
      
      // ì„±ê³µ í”¼ë“œë°±
      addLiveLog('âœ“ ì‹œìŠ¤í…œ', 'ë§ˆì´í¬ ê¶Œí•œì´ í—ˆìš©ë˜ì—ˆìŠµë‹ˆë‹¤!');
      beep(880, 0.06);
    } catch (err) {
      console.error('Audio init failed:', err);
      if (err.name === 'NotAllowedError') {
        await showModal(
          'âŒ ë§ˆì´í¬ ê¶Œí•œ ê±°ë¶€ë¨',
          '<b>ë§ˆì´í¬ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”:</b><br><br>' +
          '<u>Chrome/Edge:</u><br>' +
          '1. ì£¼ì†Œì°½ ì™¼ìª½ ìë¬¼ì‡  ğŸ”’ í´ë¦­<br>' +
          '2. "ë§ˆì´í¬" â†’ "í—ˆìš©" ì„ íƒ<br>' +
          '3. ìƒˆë¡œê³ ì¹¨ (F5)<br><br>' +
          '<u>Firefox:</u><br>' +
          'ì„¤ì • â†’ ê°œì¸ì •ë³´ â†’ ê¶Œí•œ â†’ ë§ˆì´í¬ í—ˆìš©<br><br>' +
          '<u>Safari:</u><br>' +
          'ì„¤ì • â†’ ë§ˆì´í¬ í—ˆìš©'
        );
      } else if (err.name === 'NotFoundError') {
        await showModal(
          'âš ï¸ ë§ˆì´í¬ ì—†ìŒ',
          'ì—°ê²°ëœ ë§ˆì´í¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.<br><br>' +
          'â€¢ ë§ˆì´í¬ê°€ ì—°ê²°ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸<br>' +
          'â€¢ ë‹¤ë¥¸ ì•±ì—ì„œ ë§ˆì´í¬ë¥¼ ì‚¬ìš© ì¤‘ì´ ì•„ë‹Œì§€ í™•ì¸<br>' +
          'â€¢ ì¥ì¹˜ ê´€ë¦¬ìì—ì„œ ë§ˆì´í¬ í™œì„±í™” í™•ì¸'
        );
      } else {
        await showModal(
          'âš ï¸ ì˜¤ë¥˜',
          `ê¸°ìˆ ì  ì˜¤ë¥˜: ${err.message || err.name}`
        );
      }
      throw err;
    }
  }

  function releaseAudio() {
    if (state.animationId) {
      cancelAnimationFrame(state.animationId);
      state.animationId = null;
    }
    if (state.mediaStream) {
      state.mediaStream.getTracks().forEach(track => track.stop());
      state.mediaStream = null;
    }
    state.analyser = null;
  }

  function getRMS() {
    if (!state.analyser) return 0;
    const data = new Uint8Array(state.analyser.fftSize);
    state.analyser.getByteTimeDomainData(data);
    let sum = 0;
    for (let i = 0; i < data.length; i++) {
      const norm = (data[i] - 128) / 128;
      sum += norm * norm;
    }
    return Math.sqrt(sum / data.length);
  }

  // ===== UI: TABS =====
  $$('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      $$('.tab-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      
      const tabId = btn.dataset.tab;
      $$('.section').forEach(sec => sec.classList.remove('active'));
      $(`#${tabId}`).classList.add('active');
      
      if (tabId === 'records') {
        renderRecords();
      }
    });
  });

  // ===== UI: ANIMALS =====
  $('#animalSelector').addEventListener('click', (e) => {
    const chip = e.target.closest('.chip');
    if (!chip) return;
    
    $$('#animalSelector .chip').forEach(c => c.classList.remove('active'));
    chip.classList.add('active');
    state.animal = chip.dataset.animal;
    $('#animalSelected').textContent = chip.textContent.trim();
    beep(660, 0.04);
  });

  // ===== LIVE MODE =====
  function setLiveStatus(active) {
    state.isLiveActive = active;
    $('#btnLiveStart').disabled = active;
    $('#btnLiveStop').disabled = !active;
    $('#liveState').textContent = active ? 'LIVE' : 'IDLE';
    const dot = $('#statusDot');
    if (active) {
      dot.classList.add('active');
      $('#statusText').textContent = 'LIVE';
    } else {
      dot.classList.remove('active');
      $('#statusText').textContent = 'ì¤€ë¹„ë¨';
    }
  }

  function liveUpdate() {
    const rms = getRMS();
    const level = Math.min(1, rms * 5);
    $('#liveMeterFill').style.width = (level * 100) + '%';

    // Detect voice
    const threshold = 0.04;
    if (rms < threshold) {
      state.liveStats.silenceCount++;
    }
    state.liveStats.totalCount++;

    // Max level
    if (rms > state.liveStats.maxLevel) {
      state.liveStats.maxLevel = rms;
      $('#liveMax').textContent = rms.toFixed(3);
    }

    // Time calculation
    const elapsed = (Date.now() - state.liveStats.startTime) / 1000;
    state.liveStats.voiceTime = Math.max(0, elapsed - (state.liveStats.silenceCount / 60));
    $('#liveTime').textContent = state.liveStats.voiceTime.toFixed(1) + 's';

    // Silence ratio
    const silenceRatio = state.liveStats.totalCount > 0 
      ? Math.round((state.liveStats.silenceCount / state.liveStats.totalCount) * 100)
      : 0;
    $('#liveSilence').textContent = silenceRatio + '%';

    // Random translation events
    if (rms > 0.08 && Math.random() < 0.02) {
      const phrases = {
        dog: ['ê°„ì‹ ì¤„ë˜?', 'ë†€ì•„ì¤˜!', 'ì‚°ì±… ê°€ì!', 'ì¢‹ì€ë°?', 'ë­í•´?'],
        cat: ['ê±´ë“œë¦¬ì§€ ë§ˆ', 'ë°¥ì€?', 'ì°½ë°–ì´ë‹¤', 'ì‹œë„ëŸ¬ì›Œ', 'ì–´ë”” ê°”ì–´?'],
        bird: ['ì§¹ì§¹!', 'ë°°ê³ íŒŒ!', 'ì—¬ê¸° ìˆì–´!', 'ë…¸ë˜í•´!', 'ë°–ì´ ì–´ë•Œ?'],
        rabbit: ['ê¹¡ì´!', 'ë¨¹ê³  ì‹¶ì–´', 'ì¡¸ë ¤â€¦', 'ë­ì•¼?', 'í™í™']
      };
      const pool = phrases[state.animal] || phrases.dog;
      const msg = pool[Math.floor(Math.random() * pool.length)];
      addLiveLog('ğŸ¾ í†µì—­', msg);
      beep(920, 0.03);
    }

    if (state.isLiveActive) {
      state.animationId = requestAnimationFrame(liveUpdate);
    }
  }

  $('#btnLiveStart').addEventListener('click', async () => {
    if (state.isHealthActive) {
      await showModal('ì•Œë¦¼', 'ê±´ê°•ì²´í¬ ì¤‘ì—ëŠ” LIVEë¥¼ ì‹œì‘í•  ìˆ˜ ì—†ì–´ìš”.');
      return;
    }

    try {
      await initAudio();
      state.liveStats = { silenceCount: 0, totalCount: 0, voiceTime: 0, maxLevel: 0, startTime: Date.now() };
      setLiveStatus(true);
      addLiveLog('ì‹œìŠ¤í…œ', 'LIVE ì‹œì‘ - ìŒì„± ê°ì§€ ì¤‘...');
      beep(760, 0.05);
      liveUpdate();
    } catch (err) {
      await showModal('ì˜¤ë¥˜', err.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
  });

  $('#btnLiveStop').addEventListener('click', async () => {
    setLiveStatus(false);
    releaseAudio();
    $('#liveMeterFill').style.width = '0%';
    addLiveLog('ì‹œìŠ¤í…œ', 'LIVE ì¤‘ì§€');
    beep(440, 0.05);
  });

  $('#btnClearLive').addEventListener('click', async () => {
    $('#liveLogBody').innerHTML = '';
    addLiveLog('ì‹œìŠ¤í…œ', 'ë¡œê·¸ ì´ˆê¸°í™”ë¨');
    beep(520, 0.04);
  });

  // ===== HEALTH MODE =====
  function setHealthStatus(active) {
    state.isHealthActive = active;
    $('#btnHealthStart').disabled = active;
    $('#btnHealthStop').disabled = !active;
    $('#btnSaveHealth').disabled = true;
    const dot = $('#statusDot');
    if (active) {
      dot.classList.add('active');
      $('#statusText').textContent = 'ê±´ê°•ì²´í¬ ì¤‘';
    }
  }

  function healthUpdate() {
    const rms = getRMS();
    const level = Math.min(1, rms * 5);
    $('#healthMeterFill').style.width = (level * 100) + '%';

    const elapsed = (Date.now() - state.healthStats.startTime) / 1000;
    const remaining = Math.max(0, state.healthStats.duration - elapsed);
    
    state.healthStats.samples.push(rms);
    
    if (rms < 0.04) {
      state.healthStats.silenceCount++;
    }

    // Detect peaks
    if (rms > 0.10 && state.healthStats.samples.length > 1) {
      const prev = state.healthStats.samples[state.healthStats.samples.length - 2];
      if (rms > prev) {
        state.healthStats.peakCount++;
      }
    }

    // Update UI
    $('#healthTime').textContent = Math.ceil(remaining) + 's';
    $('#healthState').textContent = 'ì¸¡ì • ì¤‘';

    const avgLevel = state.healthStats.samples.length > 0
      ? state.healthStats.samples.reduce((a, b) => a + b, 0) / state.healthStats.samples.length
      : 0;
    $('#healthAvg').textContent = avgLevel.toFixed(3);
    $('#healthPeaks').textContent = String(state.healthStats.peakCount);

    const silenceRatio = Math.round((state.healthStats.silenceCount / state.healthStats.samples.length) * 100);
    $('#healthSilence').textContent = silenceRatio + '%';

    // Signal strength
    let strength = 'ë‚®ìŒ';
    if (avgLevel > 0.05) strength = 'ì¤‘ê°„';
    if (avgLevel > 0.10) strength = 'ë†’ìŒ';
    $('#healthStrength').textContent = strength;

    if (elapsed < state.healthStats.duration) {
      state.animationId = requestAnimationFrame(healthUpdate);
    } else {
      finishHealth();
    }
  }

  function finishHealth() {
    const avgLevel = state.healthStats.samples.length > 0
      ? state.healthStats.samples.reduce((a, b) => a + b, 0) / state.healthStats.samples.length
      : 0;
    const silenceRatio = state.healthStats.samples.length > 0
      ? state.healthStats.silenceCount / state.healthStats.samples.length
      : 0;

    // Simple scoring
    let score = 100;
    score -= silenceRatio * 40;
    score -= Math.max(0, avgLevel - 0.12) * 100;
    score = Math.max(0, Math.min(100, score));

    let status = 'ì¢‹ìŒ';
    if (score < 70) status = 'ë³´í†µ';
    if (score < 40) status = 'ì£¼ì˜';

    const result = {
      timestamp: fmtDatetime(),
      duration: state.healthStats.duration,
      avgLevel: avgLevel,
      silenceRatio: silenceRatio,
      peakCount: state.healthStats.peakCount,
      score: Math.round(score),
      status: status,
      animal: state.animal
    };

    state.healthStats.currentResult = result;
    
    setHealthStatus(false);
    releaseAudio();
    $('#healthMeterFill').style.width = '0%';
    $('#healthState').textContent = 'ì™„ë£Œ';

    // Show result
    $('#healthResultBody').innerHTML = `
      <div style="line-height: 1.8;">
        <div><strong>âœ“ ì¸¡ì • ì™„ë£Œ</strong></div>
        <div style="margin-top: 12px; font-size: 12px;">
          <div>í‰ê·  ë ˆë²¨: <span style="font-family:var(--mono)">${avgLevel.toFixed(3)}</span></div>
          <div>ë¬´ìŒ ë¹„ìœ¨: <span style="font-family:var(--mono)">${Math.round(silenceRatio * 100)}%</span></div>
          <div>í”¼í¬ ê°ì§€: <span style="font-family:var(--mono)">${state.healthStats.peakCount}</span></div>
          <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--line);">
            <strong>í‰ê°€: ${status}</strong> (ì ìˆ˜: ${Math.round(score)}/100)
          </div>
        </div>
      </div>
    `;

    $('#btnSaveHealth').disabled = false;
    beep(980, 0.06);
  }

  $('#btnHealthStart').addEventListener('click', async () => {
    if (state.isLiveActive) {
      const ok = await showModal(
        'í™•ì¸',
        'LIVEë¥¼ ì¤‘ì§€í•˜ê³  ê±´ê°•ì²´í¬ë¥¼ ì‹œì‘í• ê¹Œìš”?',
        'í™•ì¸',
        'ì·¨ì†Œ'
      );
      if (!ok) return;
      
      setLiveStatus(false);
      releaseAudio();
      $('#liveMeterFill').style.width = '0%';
    }

    try {
      await initAudio();
      state.healthStats = {
        startTime: Date.now(),
        duration: 30,
        samples: [],
        peakCount: 0,
        silenceCount: 0,
        currentResult: null
      };
      setHealthStatus(true);
      $('#healthTime').textContent = '30s';
      $('#healthState').textContent = 'ì¸¡ì • ì¤‘';
      beep(760, 0.05);
      healthUpdate();
    } catch (err) {
      await showModal('ì˜¤ë¥˜', err.message);
    }
  });

  $('#btnHealthStop').addEventListener('click', () => {
    setHealthStatus(false);
    releaseAudio();
    $('#healthMeterFill').style.width = '0%';
    $('#healthState').textContent = 'ì¤‘ì§€ë¨';
    beep(440, 0.05);
  });

  $('#btnSaveHealth').addEventListener('click', () => {
    if (!state.healthStats.currentResult) return;
    saveRecord(state.healthStats.currentResult);
    $('#btnSaveHealth').disabled = true;
    beep(980, 0.04);
    addLiveLog('ì‹œìŠ¤í…œ', 'ê±´ê°•ì²´í¬ ê²°ê³¼ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
  });

  // ===== RECORDS =====
  const STORAGE_KEY = 'petctt_records_v2';

  function loadRecords() {
    try {
      return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
    } catch {
      return [];
    }
  }

  function saveRecord(record) {
    const records = loadRecords();
    records.unshift(record);
    localStorage.setItem(STORAGE_KEY, JSON.stringify(records.slice(0, 100))); // Keep max 100
  }

  function renderRecords() {
    const records = loadRecords();
    const container = $('#recordsList');
    $('#recordCount').textContent = records.length + 'ê°œ';

    if (records.length === 0) {
      container.innerHTML = '<div style="color:var(--muted); font-size:13px;">ì €ì¥ëœ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
      return;
    }

    container.innerHTML = records.map((rec, idx) => `
      <div class="log-item">
        <div class="log-item-time">${rec.timestamp} Â· ${rec.animal}</div>
        <div class="log-item-text">
          í‰ê°€: <strong>${rec.status}</strong> | ì ìˆ˜: ${rec.score}/100 | í‰ê· : ${rec.avgLevel.toFixed(3)}
        </div>
        <div style="display:flex; gap:6px; margin-top:8px;">
          <button class="btn ghost" onclick="copyRecord(${idx})" style="font-size:11px; padding:6px 10px;">ğŸ“‹ ë³µì‚¬</button>
          <button class="btn danger" onclick="deleteRecord(${idx})" style="font-size:11px; padding:6px 10px;">ğŸ—‘ï¸ì‚­ì œ</button>
        </div>
      </div>
    `).join('');
  }

  window.copyRecord = async (idx) => {
    const records = loadRecords();
    const rec = records[idx];
    if (!rec) return;
    await navigator.clipboard.writeText(JSON.stringify(rec, null, 2));
    beep(920, 0.04);
  };

  window.deleteRecord = (idx) => {
    const records = loadRecords();
    records.splice(idx, 1);
    localStorage.setItem(STORAGE_KEY, JSON.stringify(records));
    renderRecords();
    beep(440, 0.04);
  };

  $('#btnDeleteAll').addEventListener('click', async () => {
    const ok = await showModal('í™•ì¸', 'ì €ì¥ëœ ëª¨ë“  ê¸°ë¡ì„ ì‚­ì œí• ê¹Œìš”?', 'ì‚­ì œ', 'ì·¨ì†Œ');
    if (ok) {
      localStorage.removeItem(STORAGE_KEY);
      renderRecords();
      beep(440, 0.05);
    }
  });

  // Export
  function downloadFile(filename, data, type) {
    const blob = new Blob([data], { type });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(() => URL.revokeObjectURL(url), 1000);
  }

  $('#btnExportJSON').addEventListener('click', () => {
    const records = loadRecords();
    downloadFile('petctt_records.json', JSON.stringify(records, null, 2), 'application/json');
    beep(920, 0.04);
  });

  $('#btnExportCSV').addEventListener('click', () => {
    const records = loadRecords();
    if (records.length === 0) {
      showModal('ì•Œë¦¼', 'ë‚´ë³´ë‚¼ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }

    const headers = ['timestamp', 'animal', 'duration', 'avgLevel', 'silenceRatio', 'peakCount', 'score', 'status'];
    const csv = [
      headers.join(','),
      ...records.map(r => headers.map(h => {
        const v = r[h];
        if (typeof v === 'string') return `"${v.replace(/"/g, '""')}"`;
        return v;
      }).join(','))
    ].join('\n');
    
    downloadFile('petctt_records.csv', csv, 'text/csv;charset=utf-8');
    beep(920, 0.04);
  });

  // Initial
  renderRecords();
  addLiveLog('ì‹œìŠ¤í…œ', 'âœ“ PetCTT v2.0 ì¤€ë¹„ ì™„ë£Œ');
})();
</script>
</body>
</html>
